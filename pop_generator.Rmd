---
title: "POP generator"
output: html_document
params:
  pop_number: "01"
  dir: "test_01"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Parameters
```{r INFO}
# MFI values for NEG and POS cells
neg_mean <- 25000
neg_sd <- 20000
pos_mean <- 225000
pos_sd <- 20000

# phenotypes
B <-   c("CD3" = "low",  "CD4" = "low",  "CD8" = "low",  "CD56" = "low",  "CD19" = "high")
NK <-  c("CD3" = "low",  "CD4" = "low",  "CD8" = "low",  "CD56" = "high", "CD19" = "low")
T4 <-  c("CD3" = "high", "CD4" = "high", "CD8" = "low",  "CD56" = "low",  "CD19" = "low")
T8 <-  c("CD3" = "high", "CD4" = "low",  "CD8" = "high", "CD56" = "low",  "CD19" = "low")
NKT <- c("CD3" = "high", "CD4" = "high", "CD8" = "low",  "CD56" = "high", "CD19" = "low")

pheno <- as.data.frame(rbind(B, NK, T4, T8, NKT))

# number of cells per cell type
ns <- c("B" = 1000, "NK" = 1000, "T4" = 1000, "T8" = 1000, "NKT" = 1000)

# cell types
cells <- rownames(pheno)

# markers
markers <- colnames(pheno)

pheno
```

```{r}
# total number of cells
n <- sum(ns)

# creating the dataframe
set.seed(1239)
for(i in (1:length(cells))){
  c <- rep(i, ns[i])              # if I put directly the name of the cells, then the other values
  for(j in (1:length(markers))){  # will be considered as factors instead of numeric
    if(pheno[i,j] == "low"){
      p <- rnorm(ns[i], mean = neg_mean, sd = neg_sd)
    }else{
      p <- rnorm(ns[i], mean = pos_mean, sd = pos_sd)
    }
     c <- cbind(c, p)
  }
  if(i==1){
    pop <- c
  }else{
    pop <- rbind(pop, c)
  }
}

pop <- as.data.frame(pop)
names(pop) <- c("cells", markers)

for(i in (1:length(cells))){
  pop[pop$cells == i,1] <- cells[i]
}

pop$cells <- factor(pop$cells, levels = cells)
head(pop)
```

```{r}
#par(mfrow = c(ceiling(length(markers)/2), 2))
for(i in 1:length(markers)){
  boxplot(pop[,i+1] ~ pop$cells, xlab = markers[i])
}
```

```{r}
plot(pop[,2:length(markers)])
```

# Conversion to `FlowFrame` class objects
```{r}
library(flowCore)

ff <- new("flowFrame", exprs = as.matrix(pop[,-1])) 
```

```{r}
library(ggcyto)
autoplot(ff, markers[1], markers[2])
```

```{r}
autoplot(ff, markers[3])
```

# Export to .fcs
```{r}
write.FCS(ff, 
          file.path(params$dir,
            paste("ff_", params$pop_number, "_", Sys.Date(), ".fcs", sep = "")))
```




